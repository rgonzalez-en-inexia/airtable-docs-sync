name: Sync Airtable Documentation

on:
  schedule:
    # Ejecuta todos los d√≠as a las 8 AM UTC
    - cron: '0 8 * * *'
  # Tambi√©n puedes ejecutar manualmente
  workflow_dispatch:
  # Tambi√©n se ejecuta cuando se actualiza el script
  push:
    paths:
      - 'sync_airtable.py'
      - '.github/workflows/sync.yml'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    # PERMISOS CR√çTICOS - A√ëADIR ESTO
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    # PASO 1: Obtener el c√≥digo
    - name: Checkout c√≥digo con token
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    # PASO 2: Configurar Python
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    # PASO 3: Instalar dependencias
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install requests
        pip install python-dotenv
        
    # PASO 4: Crear archivo .env temporal para pruebas
    - name: Crear archivo de configuraci√≥n temporal
      run: |
        echo "AIRTABLE_TOKEN=${{ secrets.AIRTABLE_TOKEN }}" >> .env
        echo "AIRTABLE_BASE_ID=${{ secrets.AIRTABLE_BASE_ID }}" >> .env
        echo "Variables de entorno configuradas"
        
    # PASO 5: Verificar que todo est√° configurado
    - name: Verificar configuraci√≥n
      run: |
        echo "üîç Verificando secretos..."
        echo "AIRTABLE_TOKEN (primeros 10 chars): ${AIRTABLE_TOKEN:0:10}..."
        echo "AIRTABLE_BASE_ID: $AIRTABLE_BASE_ID"
        echo "GITHUB_TOKEN configurado: ${{ secrets.GITHUB_TOKEN != '' }}"
        
    # PASO 6: Ejecutar el script
    - name: Ejecutar sincronizaci√≥n
      env:
        AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "üöÄ Ejecutando script de sincronizaci√≥n..."
        python sync_airtable.py
        
        # Verificar resultados
        echo "üìä Resultado del script:"
        if [ -f "database-structure.md" ]; then
          echo "‚úÖ Archivo creado exitosamente"
          echo "üìÑ Primeras 3 l√≠neas del archivo:"
          head -3 database-structure.md
        else
          echo "‚ùå ERROR: No se cre√≥ database-structure.md"
          exit 1
        fi
        
    # PASO 7: Configurar Git para hacer commit
    - name: Configurar Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global pull.rebase false
        
    # PASO 8: Hacer commit y push de los cambios
    - name: Commit y Push de cambios
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "üîç Verificando cambios en Git..."
        git status
        
        # Agregar todos los cambios
        git add .
        
        # Verificar si hay cambios para commitear
        if git diff --cached --quiet; then
          echo "‚ÑπÔ∏è No hay cambios para commitear"
        else
          echo "üìù Creando commit con los cambios..."
          
          # Crear commit
          git commit -m "ü§ñ docs: actualizar estructura Airtable [auto]"
          
          # Hacer push
          echo "üöÄ Subiendo cambios a GitHub..."
          git push origin main
          
          echo "‚úÖ Cambios subidos exitosamente"
        fi
