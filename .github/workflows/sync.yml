name: ğŸ—‚ï¸ Sincronizar DocumentaciÃ³n Airtable

on:
  schedule:
    # Ejecuta todos los dÃ­as a las 8 AM UTC
    - cron: '0 8 * * *'
  # TambiÃ©n puedes ejecutar manualmente
  workflow_dispatch:

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    
    steps:
    # PASO 1: Descargar el cÃ³digo SIN token especial
    - name: â¬‡ï¸ Descargar cÃ³digo
      uses: actions/checkout@v4
      with:
        persist-credentials: true  # Esto usa credenciales automÃ¡ticas
        
    # PASO 2: Configurar Python
    - name: ğŸ Configurar Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    # PASO 3: Instalar dependencias
    - name: ğŸ“¦ Instalar dependencias
      run: |
        pip install requests==2.31.0
        
    # PASO 4: Verificar configuraciÃ³n
    - name: ğŸ” Verificar configuraciÃ³n
      run: |
        echo "=== VERIFICACIÃ“N DE CONFIGURACIÃ“N ==="
        echo "âœ… Python estÃ¡ configurado"
        echo "âœ… Dependencias instaladas"
        echo ""
        
    # PASO 5: Ejecutar el script principal
    - name: ğŸš€ Sincronizar con Airtable
      env:
        AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
      run: |
        echo "=== SINCRONIZANDO CON AIRTABLE ==="
        echo "ğŸ“‹ Base ID: $AIRTABLE_BASE_ID"
        echo ""
        
        # Ejecutar el script Python
        python sync_airtable.py
        
        echo ""
        echo "=== VERIFICACIÃ“N DE RESULTADOS ==="
        if [ -f "database-structure.md" ]; then
          echo "âœ… Archivo creado: database-structure.md"
          echo "ğŸ“ TamaÃ±o: $(wc -l < database-structure.md) lÃ­neas"
          echo ""
          echo "ğŸ“„ Vista previa:"
          echo "----------------"
          head -10 database-structure.md
        else
          echo "âŒ ERROR: No se creÃ³ database-structure.md"
          ls -la
          exit 1
        fi
        
    # PASO 6: Configurar Git para commit automÃ¡tico
    - name: âš™ï¸ Configurar Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions@users.noreply.github.com"
        git config --global pull.rebase false
        
    # PASO 7: Subir cambios automÃ¡ticamente (SI HAY CAMBIOS)
    - name: ğŸ“¤ Subir cambios a GitHub
      run: |
        echo "=== BUSCANDO CAMBIOS ==="
        
        # Verificar si el archivo existe y tiene cambios
        if [ ! -f "database-structure.md" ]; then
          echo "âŒ No existe database-structure.md"
          exit 1
        fi
        
        # Verificar si hay cambios
        if git diff --quiet database-structure.md 2>/dev/null; then
          echo "â„¹ï¸  No hay cambios en database-structure.md"
          echo "âœ… La documentaciÃ³n ya estÃ¡ actualizada"
        else
          echo "ğŸ“ Se detectaron cambios en database-structure.md"
          
          # Mostrar diferencias
          echo ""
          echo "ğŸ” Diferencias encontradas:"
          git diff database-structure.md | head -20
          echo ""
          
          # Agregar el archivo
          git add database-structure.md
          
          # Crear commit
          git commit -m "ğŸ“š docs(airtable): actualizar estructura de base [auto]"
          
          # Subir cambios
          echo "ğŸš€ Subiendo cambios..."
          git push
          
          echo "âœ… Cambios subidos exitosamente a GitHub"
          echo "ğŸ”„ Puedes descargar el archivo actualizado o esperar a que se actualice en Claude"
        fi
        
    # PASO 8: Opcional - Crear un release con la documentaciÃ³n
    - name: ğŸ·ï¸ (Opcional) Crear artefacto
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: airtable-documentation
        path: database-structure.md
        retention-days: 7
