name: Sync Airtable Documentation

on:
  schedule:
    # Ejecuta todos los d√≠as a las 8 AM UTC
    - cron: '0 8 * * *'
  # Tambi√©n puedes ejecutar manualmente
  workflow_dispatch:
  # Tambi√©n se ejecuta cuando se actualiza el script
  push:
    paths:
      - 'sync_airtable.py'
      - '.github/workflows/sync.yml'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Esto es NUEVO y necesario
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}  # Esto es NUEVO
        fetch-depth: 0  # Trae todo el historial
      
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Ejecutar sincronizaci√≥n
      env:
        AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
      run: |
        echo "üîç Verificando variables de entorno..."
        echo "Base ID configurada: ${AIRTABLE_BASE_ID:0:10}..."
        
        echo "üöÄ Ejecutando script..."
        python sync_airtable.py
        
        echo "üìä Verificando si se cre√≥ el archivo..."
        if [ -f "database-structure.md" ]; then
          echo "‚úÖ Archivo creado correctamente"
          ls -la database-structure.md
          echo "--- Primeras l√≠neas del archivo ---"
          head -5 database-structure.md
        else
          echo "‚ùå No se cre√≥ database-structure.md"
          exit 1
        fi
        
    - name: Configurar Git
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        
    - name: Subir cambios si hay actualizaciones
      run: |
        echo "üîç Verificando cambios..."
        git status
        
        # Verifica si hay cambios
        if git diff --quiet && git diff --staged --quiet; then
          echo "‚úÖ No hay cambios para commitear"
        else
          echo "üìù Hay cambios, creando commit..."
          git add -A
          git commit -m "üìö Actualizar docs Airtable [auto $(date +'%Y-%m-%d %H:%M')]"
          git push
          echo "‚úÖ Cambios subidos a GitHub"
        fi
