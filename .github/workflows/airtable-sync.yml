name: ğŸ—‚ï¸ Airtable Documentation Sync

on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 8 AM UTC
  workflow_dispatch:      # Manual trigger

permissions:
  contents: write

jobs:
  sync-documentation:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout repository
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 2. Setup Python
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. Install dependencies
    - name: ğŸ“¦ Install dependencies
      run: pip install requests
    
    # 4. Generate documentation
    - name: ğŸ”„ Generate Airtable documentation
      env:
        AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
      run: |
        echo "=== GENERATING DOCUMENTATION ==="
        
        # Run the Python script
        python sync_airtable.py
        
        # Verify the file was created KORU
        if [ ! -f "database-structure.md" ]; then
          echo "âŒ ERROR: database-structure.md was not created"
          exit 1
        fi

        echo "âœ… File created successfully"
        # echo "ğŸ“ File size: $(wc -c < database-structure.md) bytes"
        echo "ğŸ“ File size: $(wc -c < database-structure-aulas.md) bytes"
        echo "ğŸ“„ Preview:"
        head -10 database-structure.md
    
    # 5. Upload to GitHub using GitHub API (VERSIÃ“N CORREGIDA)
    - name: ğŸ“¤ Upload to GitHub Repository
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO: ${{ github.repository }}
      run: |
        echo "=== UPLOADING TO GITHUB REPOSITORY ==="
        
        # Check if file exists
        FILE_PATH="database-structure.md"
        if [ ! -f "$FILE_PATH" ]; then
          echo "âŒ ERROR: $FILE_PATH not found"
          exit 1
        fi
        
        # Encode file content to base64
        CONTENT_BASE64=$(base64 -w 0 "$FILE_PATH")
        
        # Get file SHA if it exists - FORMA MÃS ROBUSTA
        echo "ğŸ” Checking if file already exists in repository..."
        
        SHA=""
        API_RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/$REPO/contents/$FILE_PATH")
        
        # Extraer SHA de forma mÃ¡s robusta usando jq si estÃ¡ disponible
        if command -v jq &> /dev/null; then
          SHA=$(echo "$API_RESPONSE" | jq -r '.sha // empty')
        else
          # Fallback: extraer SHA manualmente
          SHA=$(echo "$API_RESPONSE" | grep -o '"sha"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)
        fi
        
        if [ -n "$SHA" ] && [ "$SHA" != "null" ]; then
          echo "âœ… File exists. SHA: ${SHA:0:8}..."
          COMMIT_MESSAGE="ğŸ“š docs: update airtable structure [auto]"
          NEED_SHA=true
        else
          echo "ğŸ†• File doesn't exist or SHA not found, will create new"
          COMMIT_MESSAGE="ğŸ“š docs: create airtable structure [auto]"
          NEED_SHA=false
        fi
        
        # Create JSON payload
        if [ "$NEED_SHA" = true ] && [ -n "$SHA" ]; then
          JSON_PAYLOAD='{
            "message": "'"$COMMIT_MESSAGE"'",
            "content": "'"$CONTENT_BASE64"'",
            "sha": "'"$SHA"'",
            "committer": {
              "name": "GitHub Actions",
              "email": "actions@github.com"
            },
            "branch": "main"
          }'
        else
          JSON_PAYLOAD='{
            "message": "'"$COMMIT_MESSAGE"'",
            "content": "'"$CONTENT_BASE64"'",
            "committer": {
              "name": "GitHub Actions",
              "email": "actions@github.com"
            },
            "branch": "main"
          }'
        fi
        
        echo "ğŸš€ Uploading file to GitHub..."
        echo "Payload length: ${#JSON_PAYLOAD} characters"
        
        # Make API call
        UPLOAD_RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X PUT \
          -H "Authorization: token $GH_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Content-Type: application/json" \
          -d "$JSON_PAYLOAD" \
          "https://api.github.com/repos/$REPO/contents/$FILE_PATH")
        
        # Extraer estado HTTP y respuesta
        HTTP_STATUS=$(echo "$UPLOAD_RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2)
        JSON_RESPONSE=$(echo "$UPLOAD_RESPONSE" | grep -v "HTTP_STATUS:")
        
        echo "ğŸ“Š HTTP Status: $HTTP_STATUS"
        
        # Check response
        if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "201" ]; then
          echo "ğŸ‰ SUCCESS: File uploaded to repository!"
          
          # Get commit URL
          if command -v jq &> /dev/null; then
            COMMIT_URL=$(echo "$JSON_RESPONSE" | jq -r '.commit.html_url // empty')
          else
            COMMIT_URL=$(echo "$JSON_RESPONSE" | grep -o '"html_url":"[^"]*"' | cut -d'"' -f4 | head -1)
          fi
          
          if [ -n "$COMMIT_URL" ]; then
            echo "ğŸ”— View commit: $COMMIT_URL"
          fi
          
          # Get download URL
          DOWNLOAD_URL="https://raw.githubusercontent.com/$REPO/main/$FILE_PATH"
          echo "â¬‡ï¸  Download URL: $DOWNLOAD_URL"
        else
          echo "âŒ ERROR: Failed to upload file (Status: $HTTP_STATUS)"
          echo "Response: $JSON_RESPONSE"
          exit 1
        fi
        
    # 6. Create artifact for backup
    - name: ğŸ—ƒï¸ Create backup artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: airtable-documentation
        path: database-structure.md
        retention-days: 7
