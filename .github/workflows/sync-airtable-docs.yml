name: üóÇÔ∏è Airtable Docs Sync - DEFINITIVE

on:
  schedule:
    - cron: '0 8 * * *'  # 8 AM UTC daily
  workflow_dispatch:

jobs:
  update-docs:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout solo para leer, no para escribir
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 2. Setup Python
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. Run the sync script
    - name: üîÑ Sync Airtable Structure
      env:
        AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
      run: python sync_airtable.py
    
    # 4. CREATE/UPDATE FILE VIA GITHUB API (ESTA ES LA CLAVE)
    - name: üì§ Upload to GitHub via API
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO: ${{ github.repository }}
        FILE_PATH: "database-structure.md"
      run: |
        echo "=== UPLOADING FILE VIA GITHUB API ==="
        
        # Leer el archivo generado
        if [ ! -f "$FILE_PATH" ]; then
          echo "‚ùå ERROR: $FILE_PATH not found"
          exit 1
        fi
        
        CONTENT=$(base64 -w 0 "$FILE_PATH")
        echo "üìè File size: $(wc -c < "$FILE_PATH") bytes"
        
        # Verificar si el archivo ya existe en el repo
        echo "üîç Checking if file exists in repository..."
        RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/$REPO/contents/$FILE_PATH" || echo "NOT_FOUND")
        
        SHA=""
        if echo "$RESPONSE" | grep -q '"sha"'; then
          SHA=$(echo "$RESPONSE" | grep -o '"sha":"[^"]*"' | cut -d'"' -f4)
          echo "‚úÖ File exists. SHA: $SHA"
          MESSAGE="üìö docs: update airtable structure"
        else
          echo "üÜï File doesn't exist, creating new"
          MESSAGE="üìö docs: create airtable structure"
        fi
        
        # Crear JSON para la API
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        JSON=$(cat <<EOF
        {
          "message": "$MESSAGE",
          "content": "$CONTENT",
          $( [ -n "$SHA" ] && echo "\"sha\": \"$SHA\"," )
          "committer": {
            "name": "GitHub Actions",
            "email": "actions@github.com"
          },
          "branch": "main"
        }
EOF
        )
        
        echo "üöÄ Uploading to GitHub..."
        RESPONSE=$(curl -s -X PUT \
          -H "Authorization: token $GH_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Content-Type: application/json" \
          -d "$JSON" \
          "https://api.github.com/repos/$REPO/contents/$FILE_PATH")
        
        if echo "$RESPONSE" | grep -q '"content"'; then
          echo "üéâ SUCCESS: File uploaded to repository!"
          COMMIT_URL=$(echo "$RESPONSE" | grep -o '"html_url":"[^"]*"' | cut -d'"' -f4)
          echo "üîó View commit: $COMMIT_URL"
        else
          echo "‚ùå ERROR uploading file:"
          echo "$RESPONSE"
          exit 1
        fi
